# Setup appropriate OS Leve security domains - PodSecurityPolicies, OPA, SecurityContext

## 01. PodSecurityPolicies
---

## 02. OPA
---
Its a CNCF project - https://www.openpolicyagent.org/ - focussed on ensuring simplicity in enforcing policies and a powerful yet very simplified policy authoring lifecycle. The Policy decision is made by OPA service - while Policy Enforcer can be anything. For example - a Spring Boot application in Java may use OPA to make some decisions but enforce it at the microservice level. The OPA service can run in many ways - a central service, a command line interpreter and a host of development, testing ecosystem of the policies. 

- When it comes to Kubernetes world - the policy enforcer is an admission controller. It works as a validating admission controller. So we configure a Validating Admission Controller in API server, with certificates and then run OPA itself as a Kubernetes Service and load Policy grammer (based on a DSL called REGO) is loaded as a ConfigMap. 
- We have a newer avatar of this - in form of OPA Gatekeeper for Kubernetes - which has more Kubernetes specific adoption (having a CRD concept and using a CRD named ConstraintTemplate  https://github.com/open-policy-agent/gatekeeper 
- A large library set https://github.com/open-policy-agent/gatekeeper-library

The way we can learn this subject is, 

- A. Use OPA and REGO as a standalone - without Kubernetes Integration
- B. Use OPA + Kubernetes API Server with Validating Admission Controller
- C. Use OPA gatekeeper - https://www.infoq.com/articles/implementing-policies-kubernetes/

### 02.A  Use OPA and REGO as a standalone - without Kubernetes Integration
---
Install OPA

```
ubuntu@ip-172-31-22-219:~/opa$ curl -L -o opa https://openpolicyagent.org/downloads/v0.29.4/opa_linux_amd64
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    81  100    81    0     0    346      0 --:--:-- --:--:-- --:--:--   346
100   621  100   621    0     0    877      0 --:--:-- --:--:-- --:--:--   877
100 49.4M  100 49.4M    0     0  28.8M      0  0:00:01  0:00:01 --:--:-- 56.9M
ubuntu@ip-172-31-22-219:~/opa$ ls
opa
ubuntu@ip-172-31-22-219:~/opa$ chmod 755 opa

ubuntu@ip-172-31-22-219:~/opa$ ./opa version
Version: 0.29.4
Build Commit: f110489
Build Timestamp: 2021-05-31T09:52:36Z
Build Hostname: f90b55828cf8
Go Version: go1.16.3
WebAssembly: available

```
Select a Policy test case.

https://github.com/snowdrop/kubernetes-info-webhook/blob/master/src/test/resources/admission-review.json has a JSON - which is of admission review type - the same structure Kubernetes API server will send to OPA or any policy decision endpoint for a decision making.

I thought of using this and lets consider - we would like to stop the admission of this pod request - if it does not specify from a trusted registry limits. 

```
ubuntu@ip-172-31-22-219:~/opa$ cat test.rego
package opa.policy1

deny[msg] {
   input.request.kind.kind == "Pod"
   image := input.request.object.spec.containers[_].image
   not startswith(image, "hooli.com")
   msg := sprintf("image fails to come from trusted registry: %v", [image])

}


ubuntu@ip-172-31-22-219:~/opa$ ./opa eval -i payload.json -d test.rego data.opa.policy1.deny[msg]
{
  "result": [
    {
      "expressions": [
        {
          "value": "image fails to come from trusted registry: nginx:1.7.9",
          "text": "data.opa.policy1.deny[msg]",
          "location": {
            "row": 1,
            "col": 1
          }
        }
      ],
      "bindings": {
        "msg": "image fails to come from trusted registry: nginx:1.7.9"
      }
    }
  ]
}

```
we can test the same using Rego Playground
https://play.openpolicyagent.org/





## 03. SecurityContext
---

A security context defines privilege and access control settings for a Pod or Container. It can be added in the Pod specification at a Pod spec level or Container level. These are some of the important facets on Security Context,

1. Discretionary Access Control: Permission to access an object, like a file, is based on user ID (UID) and group ID (GID).
2. Security Enhanced Linux (SELinux): Objects are assigned security labels.
3. Running as privileged or unprivileged.
4. Linux Capabilities: Give a process some privileges, but not all the privileges of the root user.
5. AppArmor: Use program profiles to restrict the capabilities of individual programs.
6. Seccomp: Filter a process's system calls.
7. AllowPrivilegeEscalation: Controls whether a process can gain more privileges than its parent process. This bool directly controls whether the no_new_privs flag gets set on the container process. AllowPrivilegeEscalation is true always when the container is: 1) run as Privileged OR 2) has CAP_SYS_ADMIN.
8. readOnlyRootFilesystem: Mounts the container's root filesystem as read-only.

In this section - I will detail Discretionary Access Control, Running as privileged or unprivileged, Linux Capabilities & AllowPrivilegeEscalation. We will discuss AppArmour and Seccomp in Section C - System Hardening and readOnlyRootFilesystem will be detailed in Section F - Ensure Immutability of container at runtime. 

### Test Pod
---

Lets build a Pod using BusyBox with with a sleep 1 day command. 

```
ubuntu@ip-172-31-22-219:~$ cat venus-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: venus
  name: venus
spec:
  containers:
  - image: busybox
    name: venus
    command: ["sleep" , "1d"]
    resources: {}
  dnsPolicy: ClusterFirst
  restartPolicy: Always
status: {}

ubuntu@ip-172-31-22-219:~$ kubectl create -f venus-pod.yaml
pod/venus created

ubuntu@ip-172-31-22-219:~$ kubectl get pods
NAME                             READY   STATUS    RESTARTS   AGE
venus                            1/1     Running   0          72s

ubuntu@ip-172-31-22-219:~$ kubectl exec -it venus -- /bin/sh
/ # ps -aef
PID   USER     TIME  COMMAND
    1 root      0:00 sleep 1d
    6 root      0:00 /bin/sh
   11 root      0:00 ps -aef

```

### Running the Pod as different user
---

As we can see - the venus pod runs as root. This root user is not the root user of the host server, but at a container level. To run it as a separate user,we need to use securityContext. 

```
ubuntu@ip-172-31-22-219:~$ cat venus-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: venus
  name: venus
spec:
  securityContext:
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
  containers:
  - image: busybox
    name: venus
    command: ["sleep" , "1d"]
    resources: {}
  dnsPolicy: ClusterFirst
  restartPolicy: Always
status: {}

ubuntu@ip-172-31-22-219:~$ kubectl create -f venus-pod.yaml
pod/venus created

ubuntu@ip-172-31-22-219:~$ kubectl exec -it venus -- /bin/sh

~ $ ps -aef
PID   USER     TIME  COMMAND
    1 1000      0:00 sleep 1d
    6 1000      0:00 /bin/sh
   13 1000      0:00 ps -aef
~ $ touch /tmp/test.txt
~ $ ls -l /tmp/test.txt
-rw-r--r--    1 1000     3000             0 Jun  5 15:34 /tmp/test.txt

```

### Running the Pod with Linux Capability
---

### Running the Pod with previledged true
---



https://gist.github.com/garethr/ea41afb1b6562cdb2b1555719f51f90e
https://medium.com/@mathurvarun98/how-to-write-great-rego-policies-dc6117679c9f
https://www.kubermatic.com/blog/opa-rego-in-a-nutshell/
https://thenewstack.io/5-things-you-didnt-know-about-open-policy-agent/
https://www.openshift.com/blog/better-kubernetes-security-with-open-policy-agent-opa-part-1
https://www.velotio.com/engineering-blog/deploy-opa-on-kubernetes
https://www.openpolicyagent.org/docs/v0.11.0/guides-kubernetes-admission-control/
https://www.openpolicyagent.org/docs/v0.12.2/kubernetes-admission-control/#4-define-a-policy-and-load-it-into-opa-via-kubernetes
https://itnext.io/open-policy-agent-opa-up-and-running-9220ff591fa1
https://medium.com/@maduranga.siriwardena/evaluating-opa-policy-with-rest-api-71e49f120547
https://www.openpolicyagent.org/docs/v0.12.2/kubernetes-admission-control/#4-define-a-policy-and-load-it-into-opa-via-kubernetes

./opa run -s ./test.rego ./payload.json
