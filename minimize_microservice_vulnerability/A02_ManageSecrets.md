# Manage Kuberenets Secrets

## A. Create a Secret (generic) type in Kubernetes 
---
By default - in vanilla K8S - secrets are kept encoded but no encrypted. Lets create a secret in default namespace. 

```
ubuntu@ip-172-31-22-219:~$ kubectl create secret generic my-secret --from-literal=password=Hello123
secret/my-secret created

ubuntu@ip-172-31-22-219:~$ kubectl describe secret my-secret
Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  8 bytes
ubuntu@ip-172-31-22-219:~$ kubectl get secret my-secret -o yaml
apiVersion: v1
data:
  password: SGVsbG8xMjM=
kind: Secret
metadata:
  creationTimestamp: "2021-06-28T17:08:27Z"
  name: my-secret
  namespace: default
  resourceVersion: "1799841"
  uid: 5a50093c-8852-4fc6-8af8-5a1ba36bdfc7
type: Opaque

ubuntu@ip-172-31-22-219:~$ echo -n "SGVsbG8xMjM=" | base64 -d
Hello123

```

## B. Retrieve the secret from ETCD
---
Install etcd client.

```
ubuntu@ip-172-31-22-219:~$ sudo apt-get install etcd-client
Reading package lists... Done

ubuntu@ip-172-31-22-219:~$ etcdctl --version
etcdctl version: 3.2.17
API version: 2

```

Connect the etcd

```
ubuntu@ip-172-31-22-219:~$ ETCDCTL_API=3 etcdctl endpoint health
127.0.0.1:2379 is unhealthy: failed to commit proposal: rpc error: code = Internal desc = grpc: the connection is drained
Error:  unhealthy cluster

ubuntu@ip-172-31-22-219:~$ sudo  ETCDCTL_API=3 etcdctl endpoint health --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key
127.0.0.1:2379 is healthy: successfully committed proposal: took = 927.545Âµs

```
Now try to read the secret and you will find that at etcd - the secret object is kept un-encrypted

```
ubuntu@ip-172-31-22-219:~$ sudo  ETCDCTL_API=3 etcdctl get /registry/secrets/default/my-secret --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key | hexdump -C
00000000  2f 72 65 67 69 73 74 72  79 2f 73 65 63 72 65 74  |/registry/secret|
00000010  73 2f 64 65 66 61 75 6c  74 2f 6d 79 2d 73 65 63  |s/default/my-sec|
00000020  72 65 74 0a 6b 38 73 00  0a 0c 0a 02 76 31 12 06  |ret.k8s.....v1..|
00000030  53 65 63 72 65 74 12 d5  01 0a b4 01 0a 09 6d 79  |Secret........my|
00000040  2d 73 65 63 72 65 74 12  00 1a 07 64 65 66 61 75  |-secret....defau|
00000050  6c 74 22 00 2a 24 35 61  35 30 30 39 33 63 2d 38  |lt".*$5a50093c-8|
00000060  38 35 32 2d 34 66 63 36  2d 38 61 66 38 2d 35 61  |852-4fc6-8af8-5a|
00000070  31 62 61 33 36 62 64 66  63 37 32 00 38 00 42 08  |1ba36bdfc72.8.B.|
00000080  08 8b 84 e8 86 06 10 00  7a 00 8a 01 63 0a 0e 6b  |........z...c..k|
00000090  75 62 65 63 74 6c 2d 63  72 65 61 74 65 12 06 55  |ubectl-create..U|
000000a0  70 64 61 74 65 1a 02 76  31 22 08 08 8b 84 e8 86  |pdate..v1"......|
000000b0  06 10 00 32 08 46 69 65  6c 64 73 56 31 3a 31 0a  |...2.FieldsV1:1.|
000000c0  2f 7b 22 66 3a 64 61 74  61 22 3a 7b 22 2e 22 3a  |/{"f:data":{".":|
000000d0  7b 7d 2c 22 66 3a 70 61  73 73 77 6f 72 64 22 3a  |{},"f:password":|
000000e0  7b 7d 7d 2c 22 66 3a 74  79 70 65 22 3a 7b 7d 7d  |{}},"f:type":{}}|
000000f0  12 14 0a 08 70 61 73 73  77 6f 72 64 12 08 48 65  |....password..He|
00000100  6c 6c 6f 31 32 33 1a 06  4f 70 61 71 75 65 1a 00  |llo123..Opaque..|
00000110  22 00 0a                                          |"..|
00000113

```


## C. Setup an Encryption Config in API Server 
---

Generate a 32 byte random key and base64 encode it

```
ubuntu@ip-172-31-22-219:~$ head -c 32 /dev/urandom | base64
<<XYZ>>=

```
Create an EncryptionConfig file

```
ubuntu@ip-172-31-22-219:~/etcd-encryption$ cat encryptionConfig.yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
    - secrets
    providers:
    - aescbc:
        keys:
        - name: key1
          secret: <<XYZ>>=
    - identity: {}

```

## D. Retrieve the secret from ETC and exhibit encrytion at REST 
---

## E. Retrieve the secret via API server and exhibit that API Server can process
