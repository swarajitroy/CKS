# GVisor

## Install GVisor
---

We will need to install GVisor
https://gvisor.dev/docs/user_guide/install/#install-from-an-apt-repository

On Worker and Master node. 

```

ubuntu@ip-172-31-17-89:~$ sudo apt-get update
Hit:1 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic InRelease
Get:2 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]
Get:3 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-backports InRelease [74.6 kB]
Get:5 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]
Get:6 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages [2099 kB]
Get:7 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-updates/universe amd64 Packages [1736 kB]
Hit:4 https://packages.cloud.google.com/apt kubernetes-xenial InRelease
Hit:8 http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.20/xUbuntu_18.04  InRelease
Get:9 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages [1753 kB]
Ign:10 https://download.falco.org/packages/deb stable InRelease
Hit:11 https://download.falco.org/packages/deb stable Release
Hit:12 https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_18.04  InRelease
Get:13 http://security.ubuntu.com/ubuntu bionic-security/universe amd64 Packages [1128 kB]
Fetched 6968 kB in 2s (4533 kB/s)
Reading package lists... Done

ubuntu@ip-172-31-17-89:~$ sudo apt-get install -y \
>     apt-transport-https \
>     ca-certificates \
>     curl \
>     gnupg-agent \
>     software-properties-common
Reading package lists... Done
Building dependency tree
Reading state information... Done
ca-certificates is already the newest version (20210119~18.04.1).
curl is already the newest version (7.58.0-2ubuntu3.13).
software-properties-common is already the newest version (0.96.24.32.14).
software-properties-common set to manually installed.
apt-transport-https is already the newest version (1.6.13).
The following NEW packages will be installed:
  gnupg-agent
0 upgraded, 1 newly installed, 0 to remove and 41 not upgraded.
Need to get 4864 B of archives.
After this operation, 43.0 kB of additional disk space will be used.
Get:1 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-updates/universe amd64 gnupg-agent all 2.2.4-1ubuntu1.4 [4864 B]
Fetched 4864 B in 0s (0 B/s)
Selecting previously unselected package gnupg-agent.
(Reading database ... 118662 files and directories currently installed.)
Preparing to unpack .../gnupg-agent_2.2.4-1ubuntu1.4_all.deb ...
Unpacking gnupg-agent (2.2.4-1ubuntu1.4) ...
Setting up gnupg-agent (2.2.4-1ubuntu1.4) ...

ubuntu@ip-172-31-17-89:~$ curl -fsSL https://gvisor.dev/archive.key | sudo apt-key add -
OK

ubuntu@ip-172-31-17-89:~$ sudo add-apt-repository "deb [arch=amd64,arm64] https://storage.googleapis.com/gvisor/releases release main"
Hit:1 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic InRelease
Hit:2 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:3 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-backports InRelease
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
Ign:6 https://download.falco.org/packages/deb stable InRelease
Hit:7 https://download.falco.org/packages/deb stable Release
Get:8 https://storage.googleapis.com/gvisor/releases release InRelease [4101 B]
Hit:9 http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.20/xUbuntu_18.04  InRelease
Hit:5 https://packages.cloud.google.com/apt kubernetes-xenial InRelease
Hit:10 https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_18.04  InRelease
Get:12 https://storage.googleapis.com/gvisor/releases release/main arm64 Packages [516 B]
Get:13 https://storage.googleapis.com/gvisor/releases release/main amd64 Packages [516 B]
Fetched 5133 B in 1s (6070 B/s)
Reading package lists... Done

ubuntu@ip-172-31-17-89:~$ sudo apt-get update && sudo apt-get install -y runsc
Hit:1 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic InRelease
Hit:2 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:3 http://us-east-2.ec2.archive.ubuntu.com/ubuntu bionic-backports InRelease
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
Hit:5 https://storage.googleapis.com/gvisor/releases release InRelease
Hit:6 https://packages.cloud.google.com/apt kubernetes-xenial InRelease
Hit:7 http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.20/xUbuntu_18.04  InRelease
Ign:8 https://download.falco.org/packages/deb stable InRelease
Hit:9 https://download.falco.org/packages/deb stable Release
Hit:10 https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_18.04  InRelease
Reading package lists... Done
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following NEW packages will be installed:
  runsc
0 upgraded, 1 newly installed, 0 to remove and 41 not upgraded.
Need to get 25.3 MB of archives.
After this operation, 0 B of additional disk space will be used.
Get:1 https://storage.googleapis.com/gvisor/releases release/main amd64 runsc amd64 20210607.0 [25.3 MB]
Fetched 25.3 MB in 1s (19.8 MB/s)
Selecting previously unselected package runsc.
(Reading database ... 118666 files and directories currently installed.)
Preparing to unpack .../runsc_20210607.0_amd64.deb ...
Unpacking runsc (20210607.0) ...
Setting up runsc (20210607.0) ...

ubuntu@ip-172-31-17-89:~$ which runsc
/usr/bin/runsc


```

## Update CRIO Config File
---

Runtime handlers are configured through CRI-O's configuration at /etc/crio/crio.conf. Valid handlers are configured under the crio.runtime table:
HANLDER_NAME=runsc

[crio.runtime.runtimes.${HANDLER_NAME}]
  runtime_path = "${PATH_TO_BINARY}"
  
```

[crio.runtime.runtimes.runsc]
runtime_path = "/usr/bin/runsc"
runtime_type = "oci"

ubuntu@ip-172-31-17-89:~$ sudo systemctl restart crio

ubuntu@ip-172-31-17-89:~$ sudo systemctl status crio
● crio.service - Container Runtime Interface for OCI (CRI-O)
   Loaded: loaded (/usr/lib/systemd/system/crio.service; enabled; vendor preset: enabled)
   Active: active (running) since Wed 2021-06-16 16:47:28 UTC; 9s ago
     Docs: https://github.com/cri-o/cri-o
 Main PID: 12883 (crio)
    Tasks: 10
   CGroup: /system.slice/crio.service
           └─12883 /usr/bin/crio

Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.013378110Z" level=info msg="About to check CNI network weave (type=weave-net)"
Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.013682829Z" level=info msg="Got pod network &{Name:testpod Namespace:default ID:0a74948bb5416cd7a898d98eda2b3c799e012c
Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.013801866Z" level=info msg="About to check CNI network weave (type=weave-net)"
Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.014090642Z" level=info msg="Got pod network &{Name:app-a Namespace:earth ID:0cc60159fa911b29a6c9505acd6a70d00077e449cd
Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.014195900Z" level=info msg="About to check CNI network weave (type=weave-net)"
Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.014466138Z" level=info msg="Got pod network &{Name:seccomp-test-pod Namespace:default ID:7b95bf923c95232739afcd89ae522
Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.014616005Z" level=info msg="About to check CNI network weave (type=weave-net)"
Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.014895415Z" level=info msg="Got pod network &{Name:pluto Namespace:default ID:76b1aeace856676feb31d0e96eb9b9a357115358
Jun 16 16:47:28 ip-172-31-17-89 crio[12883]: time="2021-06-16 16:47:28.015002048Z" level=info msg="About to check CNI network weave (type=weave-net)"
Jun 16 16:47:28 ip-172-31-17-89 systemd[1]: Started Container Runtime Interface for OCI (CRI-O).

```

## Create a Runtime class
---

```
ubuntu@ip-172-31-22-219:~/gvisor_practice$ cat runtimeClass.yaml
apiVersion: node.k8s.io/v1  # RuntimeClass is defined in the node.k8s.io API group
kind: RuntimeClass
metadata:
  name: swararoy-gvisor-rc
  # RuntimeClass is a non-namespaced resource
handler: runsc  # The name of the corresponding CRI configuration

ubuntu@ip-172-31-22-219:~/gvisor_practice$ kubectl create -f runtimeClass.yaml
runtimeclass.node.k8s.io/swararoy-gvisor-rc created

ubuntu@ip-172-31-22-219:~/gvisor_practice$ kubectl get runtimeclass
NAME                 HANDLER   AGE
swararoy-gvisor-rc   runsc     2m35s


```
